version: '3.8'

services:
  db:
    image: mariadb:10.6
    restart: unless-stopped
    environment:
      MYSQL_DATABASE: modeo_staging
      MYSQL_USER: modeo_user
      MYSQL_PASSWORD: ${DB_PASSWORD}
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}
    volumes:
      - db_data_staging:/var/lib/mysql
    networks:
      - internal
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 10s
      timeout: 5s
      retries: 5

  wordpress:
    image: wordpress:latest
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
    environment:
      WORDPRESS_DB_HOST: db:3306
      WORDPRESS_DB_USER: modeo_user
      WORDPRESS_DB_PASSWORD: ${DB_PASSWORD}
      WORDPRESS_DB_NAME: modeo_staging
      WORDPRESS_DEBUG: 1
      WORDPRESS_CONFIG_EXTRA: |
        define('WP_HOME', 'https://nextmodeo.sitefy.pl');
        define('WP_SITEURL', 'https://nextmodeo.sitefy.pl');
        define('FORCE_SSL_ADMIN', true);
        define('WP_DEBUG_LOG', true);
        define('WP_DEBUG_DISPLAY', true);
        define('WP_CACHE', true);
        define('AUTOMATIC_UPDATER_DISABLED', true);
        define('WP_ENVIRONMENT_TYPE', 'staging');
    volumes:
      - wp_data_staging:/var/www/html
      - ./backend/wp-content:/var/www/html/wp-content
      - ./uploads:/var/www/html/wp-content/uploads
    networks:
      - internal
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3

  nextjs:
    build:
      context: ./frontend
      dockerfile: Dockerfile.prod
    restart: unless-stopped
    environment:
      NODE_ENV: production
      NEXT_PUBLIC_API_URL: https://nextmodeo.sitefy.pl
      NEXT_PUBLIC_ENVIRONMENT: staging
    networks:
      - internal
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:3000/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3

  caddy:
    image: caddy:2-alpine
    restart: unless-stopped
    depends_on:
      - nextjs
      - wordpress
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./Caddyfile.staging:/etc/caddy/Caddyfile
      - caddy_data_staging:/data
      - caddy_config_staging:/config
    networks:
      - internal
    environment:
      DOMAIN: nextmodeo.sitefy.pl

  redis:
    image: redis:7-alpine
    restart: unless-stopped
    volumes:
      - redis_data_staging:/data
    networks:
      - internal
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru

volumes:
  db_data_staging:
  wp_data_staging:
  caddy_data_staging:
  caddy_config_staging:
  redis_data_staging:

networks:
  internal:
    driver: bridge